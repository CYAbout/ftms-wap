
<krpano version="1.19" >
    <events name="nadirlogofocus" keep="true" onviewchange="nadirlogo_autorotate();" />
    <!-- public events -->
    <!-- onxmlcomplete 添加了initPaintingID(),设置初始globalPaintingID的代码 -->
    <events name="skin_events" keep="true"
        onxmlcomplete="initPaintingID();set(events[skin_events].onxmlcomplete,null); skin_startup();"
        onnewpano="setNewView();skin_showloading(true); skin_update_scene_infos(); hide_skin_scroll_window();"
        onloadcomplete="loadcomplete();"
        onresize="skin_onresize();"        
        onclick="skin_click();"
        onloaderror="print_loaderror"
        onmousedown="skin_muouse_down();"  
        onenterfullscreen="enter_fullscreen();"
        onexitfullscreen="exit_fullscreen();"
    /> 

    <action name="initPaintingID">
        set(globalPaintingID,0);
        trace("config.painting.count=",get(config.painting.count));
        <!-- 设置初始globalPaintingID -->
        for(set(i,0), i LT config.painting.count, inc(i),
            trace("config.painting[get(i)].seq=",get(config.painting[get(i)].seq));
            if(config.painting[get(i)].seq == 0,set(globalPaintingID,get(config.painting[get(i)].id)));
        );
        <!-- 设置全局seq==0的场景数 globalSceneNums -->
        set(globalSceneNums,0);
        for(set(i,0), i LT scene.count, inc(i),
            if(scene[get(i)].paintingid == globalPaintingID,
            inc(globalSceneNums););
        );
    </action>

    <action name="loadcomplete">
    if(clear===1,jscall("xmlCall.initBackground();"););
        trace("loadcomplete 0 "); 
        skin_showloading(false);  
        if(vrmode == 1,uientervr(););
        
        trace("loadcomplete gyro isavailable=", get(plugin[skin_gyro].isavailable) );

        trace("loadcomplete 2 "); 

        jsget(clientWidth, "window.screen.width");
        trace("clientWidth : ",clientWidth); 
        if(clientWidth LE 320,set(layer[like_con].visible,false);set(layer[price_con].x,20););
        <!-- set(device.handheld,true); -->
        <!-- trace("layer[skin_thumbs].count=",get(scene.count)); -->
    </action>

    <action name="setNewView">
        jsget(switchSceneColorFlag, "window.switchSceneColorFlag");
        if(switchSceneColorFlag == true,setNewViewContent(););
    </action>

    <action name="setNewViewContent">
        jsget(new_hlookat, "window.switchSceneColor.new_hlookat");
        jsget(new_vlookat, "window.switchSceneColor.new_vlookat");
        jsget(new_fov, "window.switchSceneColor.new_fov");
        set(view.hlookat,get(new_hlookat));
        set(view.vlookat,get(new_vlookat));
        set(view.fov,get(new_fov));
        jscall("xmlCall.setSwitchSceneColorFlag()");
    </action>

    <action devices="!handheld" name="switchSceneColor">
        <!-- 换色前，先移除场景缩略图 -->
        for(set(i,0), i LT scene.count, inc(i),
            if(scene[get(i)].paintingid == globalPaintingID,
                txtadd(_thumb_img,'thumb_img_',get(i));
                trace("_thumb_img:",get(_thumb_img));
                removelayer(get(_thumb_img),true);)
        );
        <!-- 切换颜色后，修改全局globalPaintingID -->
        set(globalPaintingID,%1);
        trace("globalPaintingID=",get(globalPaintingID));
        <!-- 通过修改后的修改全局globalPaintingID和当前scene的title，确定要加载的新场景_newScene -->
        for(set(i,0), i LT scene.count, inc(i),
            if(scene[get(i)].paintingid == globalPaintingID 
                AND scene[get(i)].title == scene[get(xml.scene)].title,
                    set(_newScene,get(scene[get(i)].name));
                )
        );
        <!-- 加载新场景 -->
        loadscene(get(_newScene),null, MERGE,blend(0.5));
        <!-- 重新添加缩略图 -->
        skin_addthumbs();
        <!-- 重新更新当前场景 -->
        skin_update_scene_infos();
    </action>

    <action devices="handheld" name="switchSceneColor">
        <!-- 换色前，先移除场景缩略图 -->
        <!-- for(set(i,0), i LT scene.count, inc(i),
            if(scene[get(i)].paintingid == globalPaintingID,
                txtadd(_thumb_img,'thumb_img_',get(i));
                trace("_thumb_img:",get(_thumb_img));
                removelayer(get(_thumb_img),true);)
        ); -->
        <!-- 切换颜色后，修改全局globalPaintingID -->
        set(globalPaintingID,%1);
        trace("globalPaintingID=",get(globalPaintingID));
        <!-- 通过修改后的修改全局globalPaintingID和当前scene的title，确定要加载的新场景_newScene -->
        for(set(i,0), i LT scene.count, inc(i),
            if(scene[get(i)].paintingid == globalPaintingID 
                AND scene[get(i)].title == scene[get(xml.scene)].title,
                    set(_newScene,get(scene[get(i)].name));
                )
        );
        <!-- 加载新场景 -->
        loadscene(get(_newScene),null, MERGE,blend(0.5));
        <!-- 重新添加缩略图 -->
        <!-- skin_addthumbs(); -->
        <!-- 重新更新当前场景 -->
        <!-- skin_update_scene_infos(); -->
    </action>

    <action devices="handheld" name="hide_skin_scroll_window">
        set(layer[skin_scroll_window].visible,false);
    </action>
    
    <!--onnewscene="received_parameters_handler();"-->
    <!--<action name="received_parameters_handler">						
        trace("startfov=", get(startfov));
	    if(startfov !== null,
            set(view.fov, startfov);
        );
    </action>-->      
    <action protect="true" name="nadirlogo_autorotate">
        if(hotspot[nadirlogo].visible, copy(hotspot[nadirlogo].rotate, view.hlookat); );
        if(hotspot[vrgobackhall].visible, copy(hotspot[vrgobackhall].rotate, view.hlookat); );
    </action>
    <action name="print_loaderror">
        trace("onloaderror: ",lasterror);      
        
    </action>
    <action name="introresize">       
        math.max(introwidth,get(layer[introtext1].width),get(layer[introtext2].width)); 
        add(introwidth,34);
        set(layer[skin_intro].width, get(introwidth));  
        if(device.handheld, setIntro21();); 
    </action>
    <action name="setIntro21">     
        if(device.iphone,set(layer[introtext1].y,3);set(layer[introtext2].y,12);); 
        txtadd(myfunc,'xmlCall.subIntro("',get(config.intro2),'");');
        jsget(newstr,get(myfunc));
        trace("newstr:",newstr);  
        set(layer[introtext2].html,get(newstr));  
    </action>
    <action name="setIntro2">       
        set(layer[introtext2].html,get(config.intro2));
    </action>
    <action name="enter_fullscreen">  
        set(layer[fullscreen_btn].url, "%SWFPATH%/autoskin/skinpng/icon-exitfullscreen2.png");
        set(layer[fullscreen_txt].style, "menubar_text_style_sel");
            
        if(!device.handheld,
            rescale();
            jscall('xmlCall.onFullScreen(true);'); 
        ); 
    </action>
    <action name="exit_fullscreen">  
        set(layer[fullscreen_btn].url, "%SWFPATH%/autoskin/skinpng/icon-fullscreen.png");
        set(layer[fullscreen_txt].style, "menubar_text_style");
            
        if(!device.handheld,
            rescale();
            jscall('xmlCall.onFullScreen(false);'); 
        );        
    </action>
    
    <action name="rescale">
        if(device.handheld,
			<!--if(ihuawei GT -1,set(stagescale,0.8););-->					            
            set(stagescale,0.8);
            ,         
            <!--trace("pc before rescale, stagewidth = ", stagewidth, ", stagescale = ",stagescale);-->  
            jsget(clientWidth, "document.documentElement.clientWidth");
            if(fullscreen, jsget(clientWidth, "window.screen.width"););                    
            calc(ratio, clientWidth/1920);            
            if(ratio GT 1.0, set(ratio,1));
            if(ratio LT 0.8, set(ratio,0.8));            
            set(stagescale,get(ratio));
            <!--trace("pc after rescale, clientWidth = ", get(clientWidth), ", stagescale = ",stagescale,",ratio=", get(ratio), ",fullscreen=", get(fullscreen));-->
            if(device.android,set(stagescale,0.5));
        );      
        
        trace("rescale,stagescale=",get(stagescale));
    </action>
    <action devices="!handheld" name="swtich_fullscreen">        
        switch(fullscreen);
        <!--if(fullscreen,
            set(layer[fullscreen_btn].url, "%SWFPATH%/autoskin/skinpng/icon-fullscreen.png");
            set(layer[fullscreen_txt].style, "menubar_text_style");
        ,
            set(layer[fullscreen_btn].url, "%SWFPATH%/autoskin/skinpng/icon-exitfullscreen2.png");
            set(layer[fullscreen_txt].style, "menubar_text_style_sel");
        );--> 
        
        <!-- click log -->
        set(sendlog_funcall,'');
        txtadd(sendlog_funcall,'sendClickEvent("vr_full_screen_click","click","","","","","","', get(webvr.isenabled) ,'",0,0);');
        jscall(get(sendlog_funcall));   
    </action>
    <action name="skin_switch_gyro">
        if(
            plugin[skin_gyro].isavailable == false
            ,
            jscall("xmlCall.createMessageDiv('请先开启陀螺仪');")
            ,
            switch(plugin[skin_gyro].enabled);
            if(
                plugin[skin_gyro].enabled == true
                ,        
                set(layer[gyro_btn].url, "%SWFPATH%/autoskin/skinpng/icon-gyro2.png")
                ,        
                set(layer[gyro_btn].url, "%SWFPATH%/autoskin/skinpng/icon-gyro.png");
            );
            set(sendlog_funcall,'');
            txtadd(sendlog_funcall,'sendClickEvent("vr_gyro_click","click","","","","","","', get(webvr.isenabled) ,'",0,0);');
            jscall(get(sendlog_funcall)); 
        );        
    </action>
    <action name="skin_hide_ui_all">
        set(layer[skin_start_help].alpha,0);
        set(layer[skin_start_tip].alpha,0);
        set(layer[skin_control_bar].y,-120);
        set(layer[skin_qrcode_con].visible,false);
        set(layer[skin_intro].visible,false);
        set(layer[goback_con].visible,false);        
        set(layer[skin_visit_info].visible,false);
        for(set(i,0), i LT hotspot.count, inc(i),
            set(hotspot[get(i)].visible, false);
        );
    </action>    

    <action name="initconfig">
        if (config.auto_rotate == 1,
            set(autorotate.enabled, "true");
            set(autorotate.speed, get(config.auto_rotate_speed));
        );        
        set(layer[skin_qrcode].url, get(config.qrcode));
    </action>
    
    
    <!-- auto rotate -->
    <autorotate enabled="false" waittime="3.0" speed="-3.0" horizon="0.0" tofov="120.0" />
    <action devices="!handheld" name="skin_auto_next_scene">
        if(config.pc_auto_scene == 1,
            bombtimer(0);
        );
    </action>
    <action devices="handheld" name="skin_auto_next_scene">
        if(config.mobile_auto_scene == 1
        ,
            bombtimer(0);
        );
    </action>    
    <action name="bombtimer">
        set(autorotate.enabled,true);
        set(bt,%1);
        add(bt,1);
        delayedcall(1,
            bombtimer(get(bt))
        );       
        if(bt GE config.auto_scene_time,
            set(bt,0);
            skin_loop_scene();
        );
    </action>
    <action name="skin_loop_scene">
        set(next_scene_index, get(scene[get(xml.scene)].index));
        set(maxs, get(scene.count));
        add(next_scene_index,1);
        if(next_scene_index == maxs, set(next_scene_index,0));
        skin_loadscene(get(scene[get(next_scene_index)].name));
    </action>
    <action name="skin_loadscene"> 
        skin_before_loadscene(%1);
        loadscene(%1,null, MERGE,blend(0.5));
        skin_thumb_current(get(last_view_scene_index));
        set(last_view_scene_index,get(scene[get(xml.scene)].index));
        set(currscene,%1);
        skin_scene_info();
        if(device.flash,hide_hotspots_in_flashmode(););

        set(sceneid,get(scene[get(xml.scene)].id));
        set(scenename,get(scene[get(xml.scene)].name));     
        set(sendlog_funcall,'');
        txtadd(sendlog_funcall,'sendClickEvent("vr_scene_load","click","","","","',get(sceneid),'","',get(sceneName),'","', get(webvr.isenabled) ,'",0,0);');     
        jscall(get(sendlog_funcall)); 
    </action>
    
    <action name="skin_thumb_current">
        set(layer[current_thumb_%1].visible,true);
    </action>    
    <action name="skin_before_loadscene">      
        if(!device.handheld,close_start_help(); );   
    </action>
    
    <action name="ac_littleplanetintro">     
        hide_hotspots();
        <!-- 保存原场景信息 -->
        set(first_vlookatmin,get(view[0].vlookatmin));
        set(first_vlookatmax,get(view[0].vlookatmax));
        copy(lp_scene, xml.scene);
        copy(lp_hlookat, view.hlookat);
        copy(lp_vlookat, view.vlookat);
        copy(lp_fov, view.fov);
        copy(lp_fovmax, view.fovmax);
        copy(lp_fovmin, view.fovmin);
        copy(lp_limitview, view.limitview);
        
        <!-- 开场初始信息 -->
        set(view.fovmax, 170);
        set(view.limitview, lookto);
        set(view.vlookatmin, 90);
        set(view.vlookatmax, 90);
        lookat(calc(lp_hlookat - 180), 90, 150, 1, 0, 0);
        
        <!--设置启动场景图片加载完后运行-->        
        set(events[lp_events].onloadcomplete,
            delayedcall(0.1,                
                if(lp_scene === xml.scene,                    
                    set(control.usercontrol, off);
                    copy(view.limitview, lp_limitview);
                    set(view.vlookatmin, null);
                    set(view.vlookatmax, null);
                    tween(view.hlookat|view.vlookat|view.fov|view.distortion,
                        calc('' + lp_hlookat + '|' + lp_vlookat + '|' + lp_fov + '|' + 0.0),
                        2.0,
                        easeOutQuad,                        
                        set(view.fovmax,get(lp_fovmax));
                        set(view.fovmin,get(lp_fovmin));                    
                        skin_loaded();
                        <!-- show_hotspots();   -->
                        jscall("xmlCall.hotspotRecommend();");                       
                        set(control.usercontrol, all);
                    );
                );
            );
        );        
    </action>
    
    <action name="skin_startup"> 
        
        if(config.bottom_logo == 1,
            set(hotspot["nadirlogo"].visible, true);
            set(hotspot["nadirlogo"].scale, get(config.bottom_logo_scale));
            ,
             set(hotspot["nadirlogo"].visible, false);
        ); 
      
	    if(startfov !== null,set(view.fov, get(startfov)););     
        
        skin_init_gyro();
        set(last_view_scene_index,0);
        set(first_loaded_scene,true);
       
        skin_addthumbs();    
        if(config.little_planet == 1,
            <!--set_pc_hotspot_visible(false);-->
            ac_littleplanetintro();
            ,            
            set(events[lp_events].onloadcomplete,              
                delayedcall(0.1,                
                    skin_loaded();
                );
            ); 
        );  
    </action>
    
    <action name="skin_loaded">   
        skin_showloading(false);      
        if(device.handheld,,open_start_help(););      

        if(first_loaded_scene
            ,
            set(first_loaded_scene,false); 
            delayedcall(get(init_delaye_time),
                skin_init_menu(); 
                skin_showthumbs(true);  
                skin_auto_next_scene(); 
                skin_init_other();
                if(config.init_scene_anime == 1,
                    set(view.vlookatmin, get(first_vlookatmin));
                    set(view.vlookatmax, get(first_vlookatmax));
                );
            ); 
        );  
       
        <!--set_pc_hotspot_visible(true);--> 
        set(layer[introtext1].html,get(config.intro1));
        set(layer[introtext2].html,get(config.intro2));    
        
        jscall('xmlCall.updateVisitInfo()');                 
        <!-- if(!device.handheld, playmusic(););   -->
        if(device.mobile AND config.showvr,
            set(layer[aavrglasses_con].visible, true);               
        );
        <!--if(device.handheld,skin_switch_gyro(););-->     
    </action>
    <action name="playmusic">     
        if(config.music=== "",  
            set(layer[skin_btn_sound_con].visible, false);      
            set(layer[ext_con].x, 230); 
            ,   
            playsound(bgsnd, get(config.music), 0);
            tween(sound[bgsnd].volume, 0.5);

        );         
    </action>
    <action name="togglemusicplay">
        ifnot(config.music=== "",
            pausesoundtoggle(bgsnd);
            switch(layer[skin_btn_sound].url, "%SWFPATH%/autoskin/skinpng/icon-sound.png", "%SWFPATH%/autoskin/skinpng/icon-stopsound.png");
            
            trace(%0, ",sound[bgsnd].paused=", get(sound[bgsnd].paused));
            <!--if(sound[bgsnd].paused,                
                set(layer[skin_btn_sound].url, "%SWFPATH%/autoskin/skinpng/icon-sound.png");
                ,
                set(layer[skin_btn_sound].url, "%SWFPATH%/autoskin/skinpng/icon-stopsound.png");
            );-->
        set(sendlog_funcall,'');    
        txtadd(sendlog_funcall,'sendClickEvent("vr_music_click","click","","","","","","', get(webvr.isenabled) ,'",0,0);');    
        jscall(get(sendlog_funcall));                
        );            
    </action>
    
   <action devices="!handheld" name="skin_init_other"> 
        jsget(globalEnv_src,"globalEnv.src"); 
        if( returnurl === null OR globalEnv_src === 'app',          
            set(layer[goback_con].visible,false);
            set(layer[skin_intro].x,34);
        ,
          
            set(layer[goback_con].visible,true);
            set(layer[skin_intro].x,100);
        );               
        set(layer[skin_intro].visible,true);
        jsget(globalConfig_clean,"globalConfig.clean");
        if(globalConfig_clean !== '1',set(layer[skin_qrcode_con].visible,true);set(layer[skin_visit_info].visible,true););
        

        
        set(layer[skin_control_bar].visible,true);


        if(device.flash,            
            <!--set(layer[like_con].visible,false);
            set(layer[skin_visit_info].visible,false);-->
            set(layer[feedback_con].visible,false);       
        );  
        jscall('xmlCall.show_banner();'); 
        <!-- jscall('xmlCall.colorHandle();');  -->
    </action>    
    <action devices="handheld" name="skin_init_other">    
        jsget(globalEnv_src,"globalEnv.src");    
        set(layer[skin_intro].visible,true);     
        if( returnurl === null OR globalEnv_src === 'app', 
            set(layer[goback_con].visible,false);         
        ,
            set(layer[goback_con].visible,true);         
        );
        <!--set(hotspot[vrgobackhall].visible,false);-->
        
        set(layer[skin_control_bar].visible,true);
        set(ui_show,true);
        jscall('xmlCall.show_banner();'); 
    </action>    
    <action name="goback">
        jscall("xmlCall.goback();");
    </action>
    <action name="skin_click">     
        skin_showthumbs();
        if(!device.handheld,close_start_help(); );   
    </action>
    <action name="skin_muouse_down">      
        if(!device.handheld,close_start_help(); );     
        set(bt,0);        
    </action>

    <action name="skin_onresize">        
        mul(mh, area.pixelheight, -1); 
        if(layer[skin_thumbs].state == 'opened', add(mh,layer[skin_thumbs].height); );
     
        copy(destwidth, stagewidth);
        copy(destheight, stageheight);
        set(layer[itemimgpic].width,get(ww));
        set(layer[itemimgpic].height,get(hh));;
        set(layer[skin_scroll_layer].y, get(mh)) 
    </action>
    
    
    <!--  显示loading  -->
    <action name="skin_showloading">
        set(layer[skin_loadingtext].html, "图片加载中..."); set(layer[skin_loadingtext].visible, %1);
    </action>    
    <action name="skin_update_scene_infos">
        if(xml.scene !== null, 
            if(scene[get(xml.scene)].index GE 0,
                if(title, 
                    txtadd(layer[skin_title].html, get(title), ' - ', get(scene[get(xml.scene)].title) ); 
                    , 
                    copy(layer[skin_title].html, scene[get(xml.scene)].title ); 
                );
                
                for(set(i,0), i LT scene.count, inc(i),
                    txtadd(current_thumb,'thumb_bg_',get(i));
                    txtadd(current_thumb_title,'skin_thumb_title_',get(i));                
                 
                    layer[get(current_thumb)].loadstyle(thumb_bg_style);
                    layer[get(current_thumb_title)].loadstyle(skin_thumb_title_style);                
                );
                txtadd(current_thumb, 'thumb_bg_', get(scene[get(xml.scene)].index));
              
                layer[get(current_thumb)].loadstyle(thumb_bg_sel_style);
            
                txtadd(current_thumb_title,'skin_thumb_title_',get(scene[get(xml.scene)].index));
                layer[get(current_thumb_title)].loadstyle(skin_thumb_title_style_sel);               
                
                if(scene[get(xml.scene)].index GT 0,
                    set(layer[skin_btn_prev].enabled, true);
                    set(layer[skin_btn_prev].alpha, 1.0);
                    ,
                    set(layer[skin_btn_prev].enabled, false);
                    set(layer[skin_btn_prev].alpha, 0.3);
                );
                sub(lastsceneindex, scene.count, 1);
                if(scene[get(xml.scene)].index LT lastsceneindex,
                    set(layer[skin_btn_next].enabled, true);
                    set(layer[skin_btn_next].alpha, 1.0);
                    ,       
                    set(layer[skin_btn_next].enabled, false);
                    set(layer[skin_btn_next].alpha, 0.3);
                );
            );
        );
    </action>  
    <action name="open_start_help" devices="!handheld">        
        <!-- set(layer[bar_start_tip].visible,true);
        delayedcall(3,           
            tween(layer[bar_start_tip].alpha,0,0.5,easeOutQuint,set(layer[bar_start_tip].visible,false););        
        );         -->
       
        delayedcall(1,
            set(layer[skin_start_help].visible,true);
            delayedcall(3,               
                tween(layer[skin_start_help].alpha,0,0.5,easeOutQuint,
                    set(layer[skin_start_help].visible,true);
                    skin_scene_info();
                );                
            );            
        );     
        
    </action>
    <action name="close_start_help" devices="!handheld">
          tween(layer[skin_start_help].alpha,0,1,easeOutQuint,removelayer(skin_start_help));
          <!-- tween(layer[bar_start_tip].alpha,0,1,easeOutQuint); -->
    </action>
   
    <action name="skin_scene_info">       
        if(device.handheld,
            set(y_scenemame, 150);
            ,
            mul(y_scenemame,100,stagescale);  
        ); 
     
        set(currscenename,get(scene[get(currscene)].title));
        set(layer[top_scene_name].html,get(currscenename));
   
        txtadd(funccall,'xmlCall.getByteLen("', get(currscenename) , '");');           
        jsget(bytelen, get(funccall));   
        
        
        <!-- mul(scenenamewidth,bytelen,18);
        add(scenenenamebgwidth,scenenamewidth,38);
        set(layer[top_scene_name].width, get(scenenamewidth));       
        set(layer[skin_top_scene_name].width, get(scenenenamebgwidth));       
        
        stoptween(layer[skin_top_scene_name].y);
        tween(layer[skin_top_scene_name].y,get(y_scenemame),1.2,easeOutQuint);
        stopdelayedcall(nametimer);
        delayedcall(nametimer,5,
            tween(layer[skin_top_scene_name].y,-100,1.2,easeOutQuint);
        );         -->
    </action>      
<!--缩略图-->  
    <action name="skin_addthumbs"> 
        skin_addthumbs_noalbum();
        if(device.handheld,set(layer[skin_scroll_window].y,130);); 

        jsget(clientWidth, "document.documentElement.clientWidth");

        if(!device.handheld AND clientWidth LT 960,set(layer[skin_scroll_window].y,-60%);); 
    </action>
    <action name="skin_addthumbs_noalbum">  
        <!-- 修改场景数，为全局场景数 -->
        <!-- 原来是80，现在修改为92，为（thumbs_width+thumbs_padding） -->
        <!-- mul(skin_thumbs_width, 80, scene.count); -->
        mul(skin_thumbs_width, 92, globalSceneNums);
        copy(layer[skin_thumbs].width, skin_thumbs_width);
        <!-- 设置显示的缩略图索引 -->
        set(thumb_index,0);
        for(set(i,0), i LT scene.count, inc(i),
            if(scene[get(i)].paintingid == globalPaintingID,
                skin_create_thumb(get(i)););
        );
     
    </action>    
 
    <action name="skin_create_thumb">
        copy(thumb_width, skin_settings.thumbs_width);
        copy(thumb_height, skin_settings.thumbs_height);
        copy(thumb_padding, skin_settings.thumbs_padding);
        add(thumbx_offset, thumb_width, thumb_padding);
        trace("thumb_index=",thumb_index);       
        txtadd(thumb_img,'thumb_img_',%1);
        addlayer(get(thumb_img));
        if(%2 != null,
            mul(thumb_x, %2, thumbx_offset);
            ,
            mul(thumb_x, thumb_index, thumbx_offset);
        );

        copy(layer[get(thumb_img)].x, thumb_x);
        set(layer[get(thumb_img)].parent, skin_thumbs);
        copy(layer[get(thumb_img)].url, scene[%1].thumburl);
        layer[get(thumb_img)].loadstyle(thumb_img_style);
        <!-- set(layer[get(thumb_img)].linkedscene, get(scene[get(i)].name)); -->
        set(layer[get(thumb_img)].linkedscene, get(scene[%1].name));
        set(layer[get(thumb_img)].onclick,skin_loadscene(get(linkedscene)););
        copy(scene[%1].thumbx, thumb_x);
		copy(scene[%1].thumby, thumb_padding); 
        
        txtadd(thumb_bg,'thumb_bg_',%1);
        addlayer(get(thumb_bg));
        set(layer[get(thumb_bg)].parent, get(thumb_img));
        layer[get(thumb_bg)].loadstyle(thumb_bg_style);
        <!-- set(layer[get(thumb_bg)].linkedscene, get(scene[get(i)].name)); -->
        set(layer[get(thumb_bg)].linkedscene, get(scene[%1].name));
        set(layer[get(thumb_bg)].onclick,skin_loadscene(get(linkedscene)););
        
        txtadd(thumb_title_bg, 'skin_thumb_title_bg', %1);
        addlayer(get(thumb_title_bg));        
        layer[get(thumb_title_bg)].loadstyle(skin_thumb_title_bg_style);
        set(layer[get(thumb_title_bg)].parent, get(thumb_img));
        set(layer[get(thumb_title_bg)].maskchildren, "true");
        <!-- set(layer[get(thumb_title_bg)].linkedscene, get(scene[get(i)].name)); -->
        set(layer[get(thumb_title_bg)].linkedscene, get(scene[%1].name));
        set(layer[get(thumb_title_bg)].onclick,skin_loadscene(get(linkedscene)););
        
        txtadd(thumb_title, 'skin_thumb_title_',%1);
        addlayer(get(thumb_title));
        layer[get(thumb_title)].loadstyle(skin_thumb_title_style);
        set(layer[get(thumb_title)].parent, get(thumb_title_bg));
        set(layer[get(thumb_title)].html, get(scene[%1].title));
        <!-- set(layer[get(thumb_title)].linkedscene, get(scene[get(i)].name)); -->
        set(layer[get(thumb_title)].linkedscene, get(scene[%1].name));      
        set(layer[get(thumb_title)].zorder, "99");      
        set(layer[get(thumb_title)].onclick,skin_loadscene(get(linkedscene)););
        
        txtadd(current_thumb,'current_thumb_',%1);
        addlayer(get(current_thumb));        
     
        set(layer[get(current_thumb)].url,'%SWFPATH%/autoskin/skinpng/iconv1.png');
        set(layer[get(current_thumb)].crop,'100|150|50|50');
        set(layer[get(current_thumb)].width, 14);
        set(layer[get(current_thumb)].height, 14);
        
        set(layer[get(current_thumb)].keep,true);
        set(layer[get(current_thumb)].parent, get(thumb_img));
        set(layer[get(current_thumb)].align, righttop);
        set(layer[get(current_thumb)].x,4);
        set(layer[get(current_thumb)].y,4);
        set(layer[get(current_thumb)].visible,false);
        <!-- 显示的缩略图索引自增1 -->
        inc(thumb_index);
    </action>    
    <action name="skin_updatethumbscroll">
        copy(padding,skin_settings.thumbs_padding);
        if(skin_settings.thumbs_scrollindicator,
            if(woverflow GT 0,
                set(layer[skin_thumbs_scrollindicator].visible,true);
                sub(iw,pixelwidth,woverflow);
                div(pw,iw,pixelwidth);
                div(px,loverflow,woverflow);
                mul(pw,iw);
                copy(layer[skin_thumbs_scrollindicator].width,pw);
                sub(iw,pw);
                sub(iw,padding);
                sub(iw,padding);
                mul(px,iw);
                add(px,padding);
                copy(layer[skin_thumbs_scrollindicator].x,px);
                ,
                set(layer[skin_thumbs_scrollindicator].visible,false);
            );
        );
    </action>
    <action name="skin_updatescroll">
        if(layer[skin_thumbs].loaded,
            set(cursceneindex, 0);
            if(xml.scene, 
                copy(cursceneindex, scene[get(xml.scene)].index)
            );
            layer[skin_thumbs].setcenter(get(scene[get(cursceneindex)].thumbx), get(scene[get(cursceneindex)].thumby));   
        );

    </action>   
    <action name="showthumbs_click"> 
        skin_showthumbs();
        
        set(sendlog_funcall,'');
        txtadd(sendlog_funcall,'sendClickEvent("vr_showthumbs_click","click","","","","","","', get(webvr.isenabled) ,'",0,0);');
        jscall(get(sendlog_funcall));          
    </action>

    <action name="ext_click"> 
        trace("ext_click 0 "); 
        jscall("xmlCall.open_ext();");
        set(sendlog_funcall,'');
        txtadd(sendlog_funcall,'sendClickEvent("vr_switch_ext_click","click","","","","","","', get(webvr.isenabled) ,'",0,0);');
        jscall(get(sendlog_funcall));  
        trace("ext_click 1 ");         
    </action>

    <action name="skin_showthumbs">  
        <!-- jscall("xmlCall.showthumbs();") -->
        if(%1 == null, if(layer[skin_thumbs].state == 'closed', 
            set(thumbsshow,true), set(thumbsshow,false));         
            ,              
            set(thumbsshow,%1); 
        );
        mul(mh, layer[skin_scroll_layer].pixelheight, -1);      
         
        if(layer[skin_scroll_layer].y == -100%, copy(layer[skin_scroll_layer].y,mh));
        if(thumbsshow,            
            set(layer[skin_btn_thumbs].url, "%SWFPATH%/autoskin/skinpng/icon-thumbs.png");            
            set(layer[skin_btn_thumbs_txt].style, "menubar_text_style");            
            set(layer[skin_thumbs].state, 'opened');                        
            add(mh, layer[skin_thumbs].height);  
            tween(layer[skin_scroll_layer].y, get(mh), 0.5, easeOutQuint);
            set(layer[skin_thumbs_container].visible, true);
            tween(layer[skin_thumbs_container].alpha, 1.0, 0.25);
            set(layer[skin_scroll_container].visible,true);            
            ,
            set(layer[skin_btn_thumbs].url, "%SWFPATH%/autoskin/skinpng/icon-thumbs2.png");            
            set(layer[skin_btn_thumbs_txt].style, "menubar_text_style_sel");            
            set(layer[skin_thumbs].state, 'closed');
            tween(layer[skin_scroll_layer].y, get(mh), 0.5, easeOutQuint, set(layer[skin_thumbs_container].visible, false);set(layer[skin_scroll_container].visible,false););
            
            if(config.show_hit_like === null OR config.show_hit_like == 1
                ,
                set(layer[skin_right_bottom_con].y,120);
            );
        );   
    </action>    
    <action name="skin_load_index_scene">
        add(newsceneindex, scene[get(xml.scene)].index, %1);
        if(newsceneindex GE 0 AND newsceneindex LT scene.count,
            layer[skin_thumbs].scrolltocenter(get(scene[get(newsceneindex)].thumbx), get(scene[get(newsceneindex)].thumby));
            skin_loadscene(get(scene[get(newsceneindex)].name));
        );
    </action>        
    <action devices="!handheld" name="skin_init_menu">
        set(layer[skin_control_bar].visible,true);
        set(ui_show,true);
    </action>
    <action devices="handheld" name="skin_init_menu">       
        set(layer[vrglasses_con].visible,true);       
        if(plugin[skin_gyro].isavailable == true ,
        set(layer[vrglasses_con].visible,true);
        ,
        set(layer[vrglasses_con].visible,false);
       
    </action>
    <action name="skin_hide_ui_click"> 
        skin_hide_ui();
        
        set(sendlog_funcall,'');
        txtadd(sendlog_funcall,'sendClickEvent("vr_show_hide_click","click","","","","","","', get(webvr.isenabled) ,'",0,0);');
        trace(get(sendlog_funcall));
        jscall(get(sendlog_funcall));         
    </action>
    <action name="skin_hide_ui">               
        if(!device.handheld,close_start_help(); );   
        tween(layer[skin_control_bar].y,-120,0.8,easeOutQuint,set(layer[skin_control_bar].visible,false));
        set(layer[skin_right_menu_con].visible,false);
        skin_showthumbs(false);
        <!-- delayedcall(0.5,set(layer[showbar_con].visible,true));        -->
        set(layer[skin_qrcode_con].visible,false);       
        set(layer[skin_nickname].visible,false);       
        set(layer[skin_intro].visible,false);
        set(layer[skin_visit_info].visible,false);
        
        hide_hotspots();
        set(ui_show,false);            
    </action>
    <action name="skin_show_ui_click">        
        skin_show_ui();       
        set(sendlog_funcall,'');    
        txtadd(sendlog_funcall,'sendClickEvent("vr_show_hide_click","click","","","","","","', get(webvr.isenabled) ,'",0,0);');    
        jscall(get(sendlog_funcall));         
    </action>    
    <action name="skin_show_ui">
        set(layer[skin_control_bar].visible,true);
        tween(layer[skin_control_bar].y,20,1,easeOutQuint);
        <!-- set(layer[showbar_con].visible,false); -->
       
        skin_showthumbs(true);
       
        set(layer[skin_logo].visible,true);
        set(layer[skin_qrcode_con].visible,true);
        set(layer[skin_nickname].visible,true);
       
        set(layer[skin_intro].visible,true);
        set(layer[skin_visit_info].visible,true);
        
        show_hotspots();
        set(ui_show,true);            
    </action>

    <action name="skin_init_gyro">
        if(skin_settings.gyro AND !device.desktop AND device.html5,
        copy(plugin[skin_gyro].url, plugin[skin_gyro].html5_url);
        );
    </action>
    <plugin name="skin_gyro" keep="true" url="" html5_url="%SWFPATH%/plugins/gyro2.js" devices="html5" enabled="false" />
    <action name="skin_switch_msg">
        stoptween(layer[msg].alpha);
        set(layer[msg].html,%1);
        set(layer[msg].alpha,1.0);
        set(layer[msg].visible,true);
        delayedcall(2,tween(layer[msg].alpha,0,1.5,easeOutQuint,set(layer[msg].visible,false)););
    </action>
    <action name="hide_hotspots">
        for(set(i,0), i LT hotspot.count, inc(i), 
            indexoftxt(vr_menu_index, get(hotspot[get(i)].name), "vr_");            
            if(vr_menu_index EQ -1 AND hotspot[get(i)].name!=="nadirlogo" AND hotspot[get(i)].name!=="vrgobackhall" ,set(hotspot[get(i)].visible, false););  
        );
        
        hide_hotspots_in_flashmode();
    </action>        
    <action name="show_hotspots">   
        if(clear === 1,set(layer[top_skin_control_bar].visible,false););    
        for(set(i,0), i LT hotspot.count, inc(i), 
            indexoftxt(vr_menu_index, get(hotspot[get(i)].name), "vr_");
            if(vr_menu_index EQ -1 AND hotspot[get(i)].name!=="nadirlogo" AND hotspot[get(i)].name!=="vrgobackhall" AND clear !==1 ,set(hotspot[get(i)].visible, true););                 
        );
        
        hide_hotspots_in_flashmode();
    </action> 
    <action name="show_hotspots_isvrquan">  
        set(hotids,%1);
        for(set(i,0), i LT hotspot.count, inc(i), 
            if(hotspot[get(i)].htype == "image" OR  hotspot[get(i)].htype == "video" OR  hotspot[get(i)].htype == "text" , 
            txtadd(hotspot_id,"_",get(hotspot[get(i)].id),"_");
            indexoftxt(index_in_hotids, get(hotids), get(hotspot_id));
            if(index_in_hotids GT -1,set(hotspot[get(i)].visible, true);)
            )              
        );
        
        hide_hotspots_in_flashmode();
    </action> 

    <action name="open_price">        
        jscall("xmlCall.open_price();"); 
        lock_skin();
    
        set(sendlog_funcall,'');
        txtadd(sendlog_funcall,'sendClickEvent("vr_price_click","click","","","","","","', get(webvr.isenabled) ,'",0,0);');
        jscall(get(sendlog_funcall));        
    </action>
    <action name="open_feedback">        
        jscall("xmlCall.open_feedback ();"); 
        lock_skin();
    
        set(sendlog_funcall,'');
        txtadd(sendlog_funcall,'sendClickEvent("vr_feedback_click","click","","","","","","', get(webvr.isenabled) ,'",0,0);');
        jscall(get(sendlog_funcall));        
    </action>
    <action name="close_feedback">
        unlock_skin();
    </action>
    <action name="like_click">
        js(likePano());
        
        if(layer[like_btn].url!== theme_config.like_disabled_url,            
            set(sendlog_funcall,'');
            txtadd(sendlog_funcall,'sendClickEvent("vr_like","click","","","","","","', get(webvr.isenabled) ,'",0,0);');
            jscall(get(sendlog_funcall));  
        );     
    </action>
   
    <action name="uientervr">
        if(
            plugin[skin_gyro].isavailable == false,
            jscall("xmlCall.createMessageDiv('请先开启陀螺仪');");
            ,
            webvr.enterVR();
            set(sendlog_funcall,'');
            txtadd(sendlog_funcall,'sendClickEvent("vr_entervr_click","click","","","","","","', get(webvr.isenabled) ,'",0,0);');
            jscall(get(sendlog_funcall));
        );                
    </action>
    <action name="hotspotlikelog">
        set(sendlog_funcall,'');        
        txtadd(sendlog_funcall,
            'sendClickEvent("vr_hotspotlike_click","click","'
            , get(hotspot[%1].htype)  ,'","' 
            , get(hotspot[%1].id)
            ,'","' ,%1 ,'","' 
            , get(scene[get(xml.scene)].id) 
            ,'","' ,get(scene[get(xml.scene)].name) ,'",' 
            ,get(webvr.isenabled) 
            ,',0,'
            , %2,');' 
        );
        jscall(get(sendlog_funcall));  
        
        trace(0);
    </action>
</krpano>
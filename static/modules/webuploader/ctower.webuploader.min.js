(Ctower=Ctower||{}).extend=function(t,o){for(var e in o)t[e]=o[e]};var Ctower,UtilDate={getFormatDate:function(t,o){return"string"==typeof t?t=""==t?new Date:new Date(String(t).replace(/-/g,"/")):isNaN(t)||(t=this.timesToDate(t)),Date.prototype.Format=function(t){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var e in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),o)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1===RegExp.$1.length?o[e]:("00"+o[e]).substr((""+o[e]).length)));return t},"datetime"===o?t.Format("yyyy-MM-dd hh:mm:ss"):"day"===o?t.Format("yyyy-MM-dd"):"month"===o?t.Format("yyyy-MM"):"time"===o?t.Format("hh:mm"):void 0},timesToDate:function(t){return new Date(t)}};(Ctower=Ctower||{}).FileUploaderBase=function(t){this._options={FRAMEWORK_URL:"",CONTEXT_PATH:"",auto:!0,editable:!0,showName:!0,swf:"Uploader.swf",server:"",pick:"#filePicker",fileList:"#fileList",fileNumLimit:1,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},ratio:window.devicePixelRatio||1,thumbnailWidth:100,thumbnailHeight:100,multiple:!1,duplicate:!0,onFileQueued:function(t){},onUploadSuccess:function(t){},onUploadError:function(t){},onUploadComplete:function(t){},onRemoveComplete:function(t){},uploadProgress:function(t,o){}},this._webuploader=null,Ctower.extend(this._options,t)},Ctower.FileUploaderBase.prototype={setParams:function(t){this._options.params=t}},Ctower.FileUploader=function(i){Ctower.FileUploaderBase.apply(this,arguments),Ctower.extend(this._options,i);var n=i.onlyImg||!1,s=this;this.getUploader=function(){if(this._webuploader)return this._webuploader;var t=WebUploader.create({auto:this._options.auto,swf:this._options.FRAMEWORK_URL+this._options.swf,server:this._options.CONTEXT_PATH+this._options.server,pick:this._options.pick,accept:this._options.accept,fileNumLimit:this._options.fileNumLimit,duplicate:this._options.duplicate});return this._webuploader=t,this._webuploader},this.removeFile=function(t){$("#"+t.id).off().find(".file-panel").off().end().remove();var o=this.getUploader();try{o.removeFile(t)}catch(t){}s._options.onRemoveComplete(t)},this.createView=function(t){if(t.name){var o=$(this._options.fileList),e=null;i.editable&&(e=$('<div  id="'+t.id+'" class="img-item"><em class="bm-btnClose close-btn" id="del_'+t.id+'"></em><img  id="img_'+t.id+'" /></div>')),n&&(e=$('<img id="'+t.id+'" width="30" height="30" />')),this._options.showName&&!n&&$('<span class="info">'+t.name+"</span>").appendTo(e),this._options.multiple?o.append(e):o.html(e)}},this.showThumb=function(t){s.createView(t);var o=this._options.thumbnailWidth,e=this._options.thumbnailHeight;if(t.src){var i=$("#"+t.id).find("img");n&&(i=$("#"+t.id)),i.attr("src",t.src),i.attr({width:o,height:e})}},this.makeThumb=function(i){s.createView(i);var t=this._options.thumbnailWidth*this._options.ratio,o=this._options.thumbnailHeight*this._options.ratio;this._options.thumbnailWidth=t,this._options.thumbnailHeight=o,this.getUploader().makeThumb(i,function(t,o){var e=$("#"+i.id).find("img");n&&(e=$("#"+i.id)),t?e.replaceWith("<span>不能预览</span>"):e.attr("src",o)},t,o)},this.upload=function(){this.getUploader().upload()},this.stop=function(){this.getUploader().stop()};var o=this;return{init:function(){o._initUploader()},showThumb:function(t){o.showThumb(t)},upload:function(){o.upload()},stop:function(){o.stop()},onFileQueued:function(t){o._options.onFileQueued=t},onUploadSuccess:function(t){o._options.onUploadSuccess=t},onUploadError:function(t){o._options.onUploadError=t},onUploadComplete:function(t){o._options.onUploadComplete=t},onRemoveComplete:function(t){o._options.onRemoveComplete=t},uploadProgress:function(t){o._options.uploadProgress=t}}},Ctower.extend(Ctower.FileUploader.prototype,Ctower.FileUploaderBase.prototype),Ctower.extend(Ctower.FileUploader.prototype,{_initUploader:function(){var o=this,t=o.getUploader(),e=o._options.onFileQueued;t.on("fileQueued",function(t){o.makeThumb(t),e(t)});var i=o._options.uploadProgress;t.on("uploadProgress",function(t,o){i(t,o)});var n=this._options.onUploadSuccess;t.on("uploadSuccess",function(t,o){t.oId=t.id,t.datestr=UtilDate.getFormatDate(new Date,"day"),t.url=o.url,t.title=o.title,t.path=o.path,t.size=o.size,t.original=o.original,t.state=o.state,t.type=o.type,n(t)});var s=this._options.onUploadError;t.on("uploadError",function(t){s(t)});var a=this._options.onUploadComplete;t.on("uploadComplete",function(t){a(t)})}});